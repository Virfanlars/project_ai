
# 脓毒症早期预警系统项目详解

## 项目概述

这个项目是一个基于人工智能的脓毒症早期预警系统，利用MIMIC-IV临床数据库中的真实患者数据，通过多模态深度学习方法预测患者发生脓毒症的风险。脓毒症是一种危及生命的严重感染并发症，如果能够提前预测，将大大提高治疗效果和患者生存率。

## 项目文件结构及功能

### 1. 数据处理相关文件

#### `scripts/generate_derived_tables.py`
**作用**：创建MIMIC-IV数据库中的派生表，特别是`sepsis3`表。
- 代码会连接到MIMIC-IV数据库，执行SQL查询创建三个关键表：
  - `bg`表 - 存储血气分析数据
  - `sofa`表 - 存储SOFA评分（器官功能障碍评分）
  - `sepsis3`表 - 基于Sepsis-3标准（SOFA评分增加≥2且存在感染怀疑）识别脓毒症患者
- 这一步为整个项目奠定了数据基础，因为脓毒症的定义直接来源于医学标准Sepsis-3

#### `scripts/data_extraction_main.py`
**作用**：从MIMIC-IV数据库中提取患者数据。
- 连接数据库并提取：
  - ICU患者基本信息（现已限制为1000条记录）
  - 生命体征数据（心率、呼吸频率、血压等）
  - 实验室检测值（白细胞计数、乳酸值等）
  - 药物使用记录（抗生素、血管活性药物等）
  - 诊断信息和临床记录
- 生成的结果保存在`data/processed/`目录下的多个CSV文件中

#### `utils/data_loading.py`
**作用**：加载和预处理提取的数据。
- 提供`load_structured_data`函数，从CSV文件中读取处理好的数据
- 提供`generate_sample_data`函数，当真实数据不可用时生成模拟数据
- 这个模块是连接数据提取和模型训练的桥梁

#### `utils/dataset.py`
**作用**：创建训练所需的数据集格式。
- 定义`SepsisDataset`类，继承自PyTorch的Dataset类
- 实现数据增强方法（时间偏移、值扰动等）
- 处理多模态数据融合的逻辑（生命体征、实验室检查、药物、文本、知识图谱）
- 提供批量处理函数，处理缺失值和不同长度的序列

### 2. 模型相关文件

#### `models/fusion/multimodal_model.py`
**作用**：定义脓毒症预测的核心多模态Transformer模型。
- `SepsisTransformerModel`类实现了多模态融合架构：
  - 包含投影层，将各类特征映射到统一维度
  - 使用位置编码(`PositionalEncoding`类)记录时序信息
  - Transformer编码器处理序列数据和捕获长期依赖关系
  - 输出层产生每个时间点的脓毒症风险评分
- 这个模型能够同时处理时间序列数据、文本信息和知识图谱，是项目的核心

#### `scripts/model_training.py`
**作用**：训练脓毒症预测模型。
- 加载数据并划分训练、验证和测试集
- 初始化`SepsisTransformerModel`模型
- 实现训练循环和早停机制
- 评估模型性能并保存训练好的模型参数
- 结果保存在`models/best_model.pt`和`results/evaluation_results.json`中

### 3. 可视化和解释性相关文件

#### `run_visualization.py`
**作用**：生成模型结果的可视化。
- 创建多种可视化图表：
  - ROC曲线：显示模型在不同阈值下的灵敏度(真阳性率)和特异度(假阳性率)
  - 混淆矩阵：展示预测的准确性分布
  - 风险轨迹图：显示患者脓毒症风险随时间的变化
  - 特征重要性图：展示哪些临床指标对预测最重要
- 生成综合HTML报告，便于临床医生解读结果
- 输出保存在`results/figures/`目录下

#### `utils/explanation.py`
**作用**：提供模型解释功能。
- 使用SHAP值分析特征对预测的贡献
- 实现对预测结果的可解释性功能
- 支持多种解释方法和可视化技术
- 帮助理解模型为什么做出特定预测

### 4. 系统集成文件

#### `run_complete_sepsis_system.py`
**作用**：集成整个系统的执行流程。
- 提供命令行接口，支持各种执行参数
- 检查环境设置和数据库连接
- 协调各个组件的执行顺序：数据提取→模型训练→结果可视化
- 处理错误和异常情况
- 生成系统执行报告

## 生成结果的含义

### 1. 数据处理结果

#### `data/processed/patient_features.csv`
包含患者特征数据，每行代表一个患者在某个时间点的各项临床指标。这些数据是模型输入的基础，反映了患者的临床状态变化。

#### `data/processed/sepsis_labels.csv`
包含脓毒症标签，指示每个患者在每个时间点是否有脓毒症。这是模型需要预测的目标，由Sepsis-3标准确定。

#### `data/processed/text_embeddings.npz` 和 `data/processed/kg_embeddings.npz`
分别存储文本嵌入和知识图谱嵌入数据。这些是由临床文本和医学知识转化成的向量表示，使模型能够理解非结构化信息。

### 2. 模型训练结果

#### `models/best_model.pt`
保存训练好的模型参数，包含了模型学习到的所有权重和偏置值。这个文件是部署预测系统的核心。

#### `results/evaluation_results.json`
包含模型评估指标，如准确率、精确率、召回率、F1分数、ROC曲线下面积（AUROC）等。这些指标反映了模型预测脓毒症的能力。

### 3. 可视化结果

#### `results/figures/roc_curve.png`
ROC曲线图，展示了模型在不同决策阈值下的性能。曲线下面积(AUC)越大，模型性能越好。理想值为1.0，随机猜测为0.5。

#### `results/figures/confusion_matrix.png`
混淆矩阵图，显示预测正确和错误的分布情况。帮助理解模型在哪些情况下表现好/差。

#### `results/figures/risk_trajectories.png`
风险轨迹图，展示几名典型患者随时间变化的脓毒症风险评分。这对临床医生特别有价值，因为它可以显示风险如何演变，为干预提供时间窗口。

#### `results/figures/feature_importance.png`
特征重要性图，显示哪些临床指标对预测结果影响最大。这有助于医生理解模型做出预测的依据，并关注关键临床指标。

#### `results/sepsis_prediction_results.html`
综合HTML报告，汇总了所有可视化结果和模型表现，以易读的形式呈现给临床医生。

## 项目核心优势和创新点

1. **多模态融合**：结合结构化数据（生命体征、实验室值）和非结构化数据（临床文本、医学知识）进行预测。

2. **时序性考虑**：通过Transformer架构捕捉患者状态随时间的变化模式，而不仅仅是静态特征。

3. **可解释性**：提供特征重要性和风险轨迹等可视化，帮助医生理解预测原因，增强临床实用性。

4. **真实数据验证**：基于MIMIC-IV大型临床数据库的真实患者数据开发，提高结果的可靠性和临床相关性。

## 如何开始使用这个项目

1. **设置数据库连接**：配置连接到MIMIC-IV数据库的参数。

2. **生成派生表**：执行`generate_derived_tables.py`创建必要的派生表。

3. **提取和处理数据**：运行`data_extraction_main.py`提取1000条患者记录。

4. **训练模型**：执行`model_training.py`训练脓毒症预测模型。

5. **生成可视化**：运行`run_visualization.py`创建结果可视化。

或者，使用集成命令一次完成所有步骤：
```bash
python run_complete_sepsis_system.py --force_real_data --skip_derived_tables
```

这个项目旨在帮助医生提前识别脓毒症风险患者，争取宝贵的干预时间，最终改善患者预后和降低病死率。通过人工智能和大数据方法，它代表了医疗AI辅助决策系统的一个实际应用。
